<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Ï∂ïÏ†ú Îã¨Î†•</title>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .calendar-container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; }
        .calendar-container h2 { text-align: left!important; font-size: 1.2rem; font-weight: 700; margin-bottom: 5px!important; color:#495057; }
        .calendar-container .current-month { font-size: 2.5rem; font-weight: 800; color:#FF7732; display:block; margin-bottom:20px; }
        .calendar-nav { position:absolute; top:50px; right:30px; z-index:15; display:flex; align-items:center; }
        .calendar-nav button { background:none; border:1px solid #ccc; border-radius:50%; width:38px; height:38px; color:#FF7732; font-weight:bold; font-size:1.2rem; margin-left:5px; cursor:pointer; transition:background-color 0.2s; }
        .calendar-nav button:hover { background-color:#f0f0f0; }
        .calendar-header, .calendar-body { display:grid; grid-template-columns:repeat(7,1fr); }
        .day-of-week { padding:15px 10px; text-align:center; font-size:1.1rem; font-weight:700; border-bottom:2px solid #FF7732; background-color:white; color:#495057; }
        .day-of-week:nth-child(1){color:#dc3545;} .day-of-week:nth-child(7){color:#0d6efd;}
        .calendar-cell { min-height:100px; padding:10px; text-align:center; border-right:1px solid #f0f0f0; border-bottom:1px solid #f0f0f0; cursor:pointer; position:relative; }
        .calendar-cell .date-number { font-size:1.5rem; font-weight:500; color:#495057; margin-bottom:5px; }
        .festival-count { font-size:0.8rem; color:#FF7732; display:block; margin-top:5px; font-weight:500; }
        .calendar-cell:hover:not(.empty-cell):not(.selected){ background-color:rgba(255,119,50,0.10); border:3px solid #FF7732; border-radius:8px; margin:-2px; z-index:5; }
        .calendar-cell.selected { background-color:#FF7732!important; color:white!important; border:none!important; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
        .calendar-cell.selected .date-number, .calendar-cell.selected .festival-count { color:white!important; }
    </style>

    <!-- ÏÑúÎ≤Ñ JSON Îç∞Ïù¥ÌÑ∞ -->
 <script th:inline="javascript">
    const festivalData = JSON.parse(/*[[${festivalJson}]]*/ '[]');
    console.log("üéâ festivalData =", festivalData);
</script>
</head>

<body>
    <div layout:fragment="content" class="container my-3">

        <div class="calendar-container">
            <div class="calendar-nav">
                <button id="prevMonthBtn">&larr;</button>
                <button id="nextMonthBtn">&rarr;</button>
            </div>

            <h2>ÏõîÎ≥Ñ Ï∂ïÏ†ú Îã¨Î†•</h2>
            <span class="current-month"></span>

            <div class="calendar-header">
                <div class="day-of-week">Ïùº</div>
                <div class="day-of-week">Ïõî</div>
                <div class="day-of-week">Ìôî</div>
                <div class="day-of-week">Ïàò</div>
                <div class="day-of-week">Î™©</div>
                <div class="day-of-week">Í∏à</div>
                <div class="day-of-week">ÌÜ†</div>
            </div>

            <div class="calendar-body" id="festivalCalendar"></div>
        </div>

        <hr class="my-5">

        <h3>Ï∂ïÏ†ú Î¶¨Ïä§Ìä∏</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="festivalList"></div>

 <script>
$(document).ready(function() {

    // Ïò§Îäò ÎÇ†Ïßú
    const today = new Date();

    // URLÏóêÏÑú year, month ÏùΩÍ∏∞
    const urlParams = new URLSearchParams(window.location.search);
    let currentYear = parseInt(urlParams.get("year"));
    let currentMonth = parseInt(urlParams.get("month"));

    // üìå URL ÌååÎùºÎØ∏ÌÑ∞ ÏóÜÎäî Í≤ΩÏö∞ ‚Üí Ïò§Îäò Í∏∞Ï§Ä
    if (isNaN(currentYear) || isNaN(currentMonth)) {
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        window.history.replaceState({}, "", `/calendar?year=${currentYear}&month=${currentMonth}`);
    }

    $('.current-month').text(`${currentYear}.${String(currentMonth).padStart(2,'0')}`);

    // üìå ÎÇ†ÏßúÎ≥Ñ Ï∂ïÏ†ú Í∞úÏàò Ïπ¥Ïö¥Ìä∏
    const getFestivalCounts = (year, month) => {
        const counts = {};
        const daysInMonth = new Date(year, month, 0).getDate();

        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const active = festivalData.filter(f =>
                new Date(f.date_start) <= new Date(dateStr)
                && new Date(f.date_end) >= new Date(dateStr)
            );
            if (active.length > 0) counts[dateStr] = active.length;
        }
        return counts;
    };

    // üìå Îã¨Î†• Î†åÎçîÎßÅ
    const renderCalendar = (year, month) => {
        const calendarEl = $('#festivalCalendar');
        calendarEl.empty();
        $('.current-month').text(`${year}.${String(month).padStart(2,'0')}`);

        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        const counts = getFestivalCounts(year, month);

        for (let i = 0; i < firstDay; i++) {
            calendarEl.append('<div class="calendar-cell empty-cell"></div>');
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const count = counts[dateStr] || 0;

            calendarEl.append(`
                <div class="calendar-cell ${count>0 ? 'has-festivals':''}" data-date="${dateStr}">
                    <div class="date-number">${day}</div>
                    ${count>0 ? `<span class="festival-count">${count}Í∞ú</span>`:''}
                </div>
            `);
        }

        $('.calendar-cell.has-festivals').on('click', clickDate);
    };

    // üìå ÎÇ†Ïßú ÌÅ¥Î¶≠ ‚Üí Î¶¨Ïä§Ìä∏ ÌëúÏãú
    function clickDate() {
        const dateStr = $(this).data('date');
        $('.calendar-cell').removeClass('selected');
        $(this).addClass('selected');
        renderFestivalList(dateStr);
    }

    // üìå Î¶¨Ïä§Ìä∏ Ï∂úÎ†•
    const renderFestivalList = (dateStr) => {
        const el = $('#festivalList');
        el.empty();

        const filtered = festivalData.filter(f =>
            new Date(f.date_start) <= new Date(dateStr)
            && new Date(f.date_end) >= new Date(dateStr)
        );

        if (filtered.length === 0) {
            el.append('<div class="col"><p>Ïù¥ ÎÇ†ÏóêÎäî Ï∂ïÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</p></div>');
        } else {
            filtered.forEach(f => {
                el.append(`
                    <div class="col">
                        <div class="card h-100">
                            <img src="${f.image}" style="height:150px; object-fit:cover;">
                            <div class="card-body">
                                <h5 class="card-title">${f.subject}</h5>
                                <p>${f.travelInfo_place}</p>
                                <small>${f.date_start} ~ ${f.date_end}</small>
                            </div>
                        </div>
                    </div>
                `);
            });
        }
    };

    // üìå Ïõî Ïù¥Îèô
    $('#prevMonthBtn').on('click', () => {
        let m = currentMonth - 1;
        let y = currentYear;
        if (m < 1) { m = 12; y--; }
        window.location.href = `/calendar?year=${y}&month=${m}`;
    });

    $('#nextMonthBtn').on('click', () => {
        let m = currentMonth + 1;
        let y = currentYear;
        if (m > 12) { m = 1; y++; }
        window.location.href = `/calendar?year=${y}&month=${m}`;
    });

    renderCalendar(currentYear, currentMonth);

});
</script>

    </div>
</body>
</html>
