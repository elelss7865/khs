<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>ì¶•ì œ ë‹¬ë ¥</title>
    <!-- jQueryëŠ” layout.htmlì— ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤ -->

    <style>
        /* =================================================================
         * CSS: ë‹¬ë ¥ ë ˆì´ì•„ì›ƒ ë° ìŠ¤íƒ€ì¼ (ìƒëµ - ë³€ê²½ ì—†ìŒ)
         * ================================================================= */
        body { font-family: 'Noto Sans KR', sans-serif; }
        .calendar-container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; }
        .calendar-container h2 { text-align: left!important; font-size: 1.2rem; font-weight: 700; margin-bottom: 5px!important; color:#495057; }
        .calendar-container .current-month { font-size: 2.5rem; font-weight: 800; color:#FF7732; display:block; margin-bottom:20px; }
        
        /* ì›” ì´ë™ ë²„íŠ¼ */
        .calendar-nav { position:absolute; top:50px; right:30px; z-index:15; display:flex; align-items:center; }
        .calendar-nav button { background:none; border:1px solid #ccc; border-radius:50%; width:38px; height:38px; color:#FF7732; font-weight:bold; font-size:1.2rem; margin-left:5px; cursor:pointer; transition:background-color 0.2s; }
        .calendar-nav button:hover { background-color:#f0f0f0; }
        
        /* ë‹¬ë ¥ í—¤ë” ë° ë³¸ë¬¸ ê·¸ë¦¬ë“œ */
        .calendar-header, .calendar-body { display:grid; grid-template-columns:repeat(7,1fr); }
        .day-of-week { padding:15px 10px; text-align:center; font-size:1.1rem; font-weight:700; border-bottom:2px solid #FF7732; background-color:white; color:#495057; }
        .day-of-week:nth-child(1){color:#dc3545;} /* ì¼ìš”ì¼ */
        .day-of-week:nth-child(7){color:#0d6efd;} /* í† ìš”ì¼ */
        
        /* ë‹¬ë ¥ ë‚ ì§œ ì…€ */
        .calendar-cell { min-height:100px; padding:10px; text-align:center; border-right:1px solid #f0f0f0; border-bottom:1px solid #f0f0f0; cursor:pointer; position:relative; }
        .calendar-cell .date-number { font-size:1.5rem; font-weight:500; color:#495057; margin-bottom:5px; }
        .festival-count { font-size:0.8rem; color:#FF7732; display:block; margin-top:5px; font-weight:500; }
        
        /* í˜¸ë²„ ë° ì„ íƒ íš¨ê³¼ */
        .calendar-cell:hover:not(.empty-cell):not(.selected){ background-color:rgba(255,119,50,0.10); border:3px solid #FF7732; border-radius:8px; margin:-2px; z-index:5; }
        .calendar-cell.selected { background-color:#FF7732!important; color:white!important; border:none!important; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
        .calendar-cell.selected .date-number, .calendar-cell.selected .festival-count { color:white!important; }
    </style>

    <!-- ì„œë²„ JSON ë°ì´í„° ë° ë³€ìˆ˜ ì„ ì–¸ (Thymeleaf) -->
 <script th:inline="javascript">
    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ JSON ë°ì´í„°ë¥¼ JavaScript ë°°ì—´ë¡œ íŒŒì‹±
    const festivalData = JSON.parse(/*[[${festivalJson}]]*/ '[]');
    
    // í˜„ì¬ ë…„ë„ì™€ ì›”ì„ ì „ì—­ ë³€ìˆ˜ë¡œ ì •ì˜
    const currentYear = /*[[${currentYear}]]*/ 0;
    const currentMonth = /*[[${currentMonth}]]*/ 0;
    
    console.log("ğŸ‰ festivalData (ì´ ê°œìˆ˜):", festivalData.length);
    if (festivalData.length > 0) {
        console.log("ğŸ‰ festivalData (ì²« ë²ˆì§¸ í•­ëª©):", festivalData[0]);
    }
    console.log(`ğŸ“… Current Period: ${currentYear}-${currentMonth}`);
</script>
</head>

<body>
    <div layout:fragment="content" class="container my-3">

        <!-- ë‹¬ë ¥ UI ì˜ì—­ -->
        <div class="calendar-container">
            <div class="calendar-nav">
                <button id="prevMonthBtn">&larr;</button>
                <button id="nextMonthBtn">&rarr;</button>
            </div>

            <h2>ì›”ë³„ ì¶•ì œ ë‹¬ë ¥</h2>
            <span class="current-month"></span>

            <div class="calendar-header">
                <div class="day-of-week">ì¼</div>
                <div class="day-of-week">ì›”</div>
                <div class="day-of-week">í™”</div>
                <div class="day-of-week">ìˆ˜</div>
                <div class="day-of-week">ëª©</div>
                <div class="day-of-week">ê¸ˆ</div>
                <div class="day-of-week">í† </div>
            </div>

            <div class="calendar-body" id="festivalCalendar"></div>
        </div>

        <hr class="my-5">

        <!-- ì¶•ì œ ë¦¬ìŠ¤íŠ¸ UI ì˜ì—­ -->
        <h3>ì¶•ì œ ë¦¬ìŠ¤íŠ¸</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="festivalList"></div>

 <script>
 
 /*
  * =================================================================
  * ğŸ“Œ JavaScript í•µì‹¬ ë¡œì§ (ë‹¬ë ¥ ê³„ì‚° ë° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§)
  * =================================================================
  */

 // [ìˆ˜ì •] ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ë‚ ì§œ í¬ë§·ì„ YYYY-MM-DDë¡œ ë³€í™˜ (2025.10.18 -> 2025-10-18)
 const normalizeDate = (dateStr) => {
     if (!dateStr) return null;
     const trimmed = dateStr.trim();
     
     // 1. ì (.)ìœ¼ë¡œ êµ¬ë¶„ëœ í˜•ì‹ (DBì—ì„œ ë„˜ì–´ì˜¨ ë°ì´í„° í˜•ì‹) ì²˜ë¦¬
     const parts = trimmed.split('.');
     if (parts.length === 3) {
        // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ë³€í™˜í•˜ì—¬ Date ê°ì²´ ìƒì„±ì— ìš©ì´í•˜ê²Œ í•¨
        return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
     }
     
     // 2. ì´ë¯¸ í•˜ì´í”ˆ(-)ìœ¼ë¡œ êµ¬ë¶„ëœ í˜•ì‹ ì²˜ë¦¬ (ëŒ€ë¶€ë¶„ì˜ ê²½ìš° Date ê°ì²´ëŠ” ì´ í˜•ì‹ì„ ì˜ ì¸ì‹í•¨)
     return trimmed.replace(/\./g, '-');
 };

 // ğŸ“Œ 1. íŠ¹ì • ë‚ ì§œì— ì§„í–‰ ì¤‘ì¸ ì¶•ì œ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
 const getFestivalCounts = (year, month, festivalData) => {
     const counts = {};
     const monthStr = String(month).padStart(2, '0');
     
     // 1-1. í•´ë‹¹ ì›”ì˜ ëª¨ë“  ë‚ ì§œ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
     const daysInMonth = new Date(year, month, 0).getDate();
     for (let day = 1; day <= daysInMonth; day++) {
         const dateStr = `${year}-${monthStr}-${String(day).padStart(2, '0')}`;
         counts[dateStr] = 0;
     }

     festivalData.forEach(f => {
         // ë°ì´í„°ë² ì´ìŠ¤ í•„ë“œ ì´ë¦„ ì‚¬ìš©: travel_start_date, travel_end_date
 		const startRaw = f.travel_start_date || f.date_start;
   		 const endRaw   = f.travel_end_date || f.date_end;

    	const normalizedStartDateStr = normalizeDate(startRaw);
   	 const normalizedEndDateStr   = normalizeDate(endRaw);
         
         if (!normalizedStartDateStr || !normalizedEndDateStr) return;

         // 1-2. Date ê°ì²´ ìƒì„± ì‹œ, 'T00:00:00'ì„ ì¶”ê°€í•˜ì—¬ Timezone ë¬¸ì œ íšŒí”¼ (í•µì‹¬)
         // [ìˆ˜ì •] Date ê°ì²´ ìƒì„± ì „/í›„ ë¡œê·¸ ì¶”ê°€
         const startDate = new Date(normalizedStartDateStr + 'T00:00:00');
         const endDate = new Date(normalizedEndDateStr + 'T00:00:00');

         // ë‚ ì§œ ê°ì²´ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê±´ë„ˆë›°ê¸°
         if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
             // [ë””ë²„ê¹…] Invalid Date ë¡œê·¸ ì¶œë ¥
             console.error(`ğŸ”´ Invalid Date for festival ${f.subject}: Normalized Start=${normalizedStartDateStr}, Normalized End=${normalizedEndDateStr}`);
             return;
         }
         
         // [ë””ë²„ê¹…] ìœ íš¨í•œ Date ê°ì²´ í™•ì¸ ë¡œê·¸
         // console.log(`âœ… Valid Date for ${f.subject}: Start=${startDate.toISOString().slice(0, 10)}, End=${endDate.toISOString().slice(0, 10)}`);


         const firstDayOfMonth = new Date(year, month - 1, 1);
         const lastDayOfMonth = new Date(year, month, 0);

         // 1-3. ì¶•ì œ ê¸°ê°„ì´ í•´ë‹¹ ì›”ê³¼ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
         if (startDate.getTime() <= lastDayOfMonth.getTime() && endDate.getTime() >= firstDayOfMonth.getTime()) {
             
             // 1-4. ê²¹ì¹˜ëŠ” ê¸°ê°„ ì¤‘ í•´ë‹¹ ì›”ì— ì†í•˜ëŠ” ë‚ ì§œë§Œ ìˆœíšŒí•˜ë©° ì¹´ìš´íŠ¸ ì¦ê°€
             const loopStart = new Date(Math.max(startDate.getTime(), firstDayOfMonth.getTime())); 
             const loopEnd = new Date(Math.min(endDate.getTime(), lastDayOfMonth.getTime()));

             let currentDate = new Date(loopStart);
             // endDateëŠ” ì¶•ì œê°€ ëë‚œ ë‹¤ìŒ ë‚ ë¡œ ê³„ì‚°ë˜ë¯€ë¡œ, <= ëŒ€ì‹  <ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¹ì¼ í¬í•¨
             while (currentDate.getTime() <= loopEnd.getTime()) { 
                 const dateKey = currentDate.toISOString().slice(0, 10);
                 if (counts[dateKey] !== undefined) {
                     counts[dateKey]++;
                 }
                 currentDate.setDate(currentDate.getDate() + 1);
             }
         }
     });
     
     console.log("ğŸ“Š Festival Counts for the month (All days):", counts);
     
     // [ë””ë²„ê¹…] ì¹´ìš´íŠ¸ê°€ 1 ì´ìƒì¸ ë‚ ì§œë§Œ ì¶œë ¥
     const positiveCounts = Object.entries(counts).filter(([key, value]) => value > 0);
     if (positiveCounts.length > 0) {
         console.log("âœ… Festival Counts (Positive):", positiveCounts);
     } else {
         console.log("âŒ No Festivals found in this month (All counts are 0).");
     }
     
     return counts;
 };


 // ğŸ“Œ 2. ì¶•ì œ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ í•¨ìˆ˜ (ë‚ ì§œ í´ë¦­ ì‹œ ì¶•ì œ ì¹´ë“œë“¤ì„ ë Œë”ë§)
 const renderFestivalList = (dateStr) => {
    const el = $('#festivalList');
    el.empty();

    const selectedDate = new Date(dateStr + 'T00:00:00');

    const filtered = festivalData.filter(f => {
        const startRaw = f.travel_start_date || f.date_start;
        const endRaw   = f.travel_end_date || f.date_end;

        const normalizedStartDateStr = normalizeDate(startRaw);
        const normalizedEndDateStr   = normalizeDate(endRaw);

        if (!normalizedStartDateStr || !normalizedEndDateStr) return false;

        const startDate = new Date(normalizedStartDateStr + 'T00:00:00');
        const endDate = new Date(normalizedEndDateStr + 'T00:00:00');

        return startDate.getTime() <= selectedDate.getTime() && selectedDate.getTime() <= endDate.getTime();
    });

    console.log(`ğŸ“ Filtered list for ${dateStr}: ${filtered.length} festivals.`);

    if (filtered.length === 0) {
        el.append('<div class="col-12"><p class="text-center text-muted py-4">ì„ íƒí•˜ì‹  ë‚ ì§œì— ì§„í–‰ ì¤‘ì¸ ì¶•ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>');
    } else {

        filtered.forEach(travel => {
        	const imgSrc = travel.filePath || travel.image || travel.img || 'https://placehold.co/239x300?text=No+Image';
            const place = travel.travelInfo_place || "ì¥ì†Œ ì •ë³´ ì—†ìŒ";
            const day = travel.travelInfo_day || `${travel.travel_start_date} ~ ${travel.travel_end_date}`;
            const recommendCount = travel.voter ? travel.voter.length : 0;

            el.append(`
                <div class="col">
                    <div class="card" style="width: 15rem;">
                    <img src="${imgSrc}" style="width:239px; height:300px;" class="card-img-top"/>
                        <div class="card-body">
                            
                            <h5 class="card-title fw-bold mb-1">
                                <a href="/travel/detail/${travel.id}" class="text-decoration-none text-dark">
                                    ${travel.subject}
                                </a>
                            </h5>

                            <div class="card-text small text-secondary mb-1">
                                ê¸°ê°„: <span>${day}</span>
                            </div>

                            <div class="card-text small text-secondary mb-3">
                                ì¥ì†Œ: <span>${place}</span>
                            </div>

                            <div class="small text-muted border-top pt-2">
                                ì¶”ì²œìˆ˜ : <span>${recommendCount}</span>
                            </div>

                        </div>
                    </div>
                </div>
            `);
        });
    }
};


 // ğŸ“Œ 3. ë‹¬ë ¥ ì…€ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 const clickDate = (dateStr) => {
     // ëª¨ë“  ì…€ì˜ selected í´ë˜ìŠ¤ ì œê±°
     $('.calendar-cell').removeClass('selected');

     // í˜„ì¬ í´ë¦­ëœ ì…€ì— selected í´ë˜ìŠ¤ ì¶”ê°€ (ì„ íƒ í‘œì‹œ)
     const targetCell = $(`[data-date="${dateStr}"]`);
     if (targetCell.length) {
         targetCell.addClass('selected');
     }

     // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
     renderFestivalList(dateStr); 
 };


 // ğŸ“Œ 4. ë‹¬ë ¥ì„ ì‹¤ì œë¡œ HTMLì— ê·¸ë¦¬ëŠ” í•µì‹¬ í•¨ìˆ˜
 const renderCalendar = (year, month) => {
     const calendarEl = $('#festivalCalendar');
     calendarEl.empty();
     
     // 4-1. í•´ë‹¹ ì›”ì˜ ì •ë³´ ê³„ì‚°
     const firstDayOfMonth = new Date(year, month - 1, 1);
     const startDayOfWeek = firstDayOfMonth.getDay(); 
     const daysInMonth = new Date(year, month, 0).getDate();
     
     // 4-2. ì¶•ì œ ì¹´ìš´íŠ¸ ë°ì´í„° ë¯¸ë¦¬ ê³„ì‚°
     const festivalCounts = getFestivalCounts(year, month, festivalData);

     // 4-3. ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
     for (let i = 0; i < startDayOfWeek; i++) {
         calendarEl.append('<div class="calendar-cell empty-cell"></div>');
     }

     // 4-4. í•´ë‹¹ ì›”ì˜ ë‚ ì§œ ì±„ìš°ê¸°
     for (let day = 1; day <= daysInMonth; day++) {
         const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
         const count = festivalCounts[dateStr] || 0; // ì¹´ìš´íŠ¸ ê°’ ê°€ì ¸ì˜¤ê¸°
         
         const cell = $(`
             <div class="calendar-cell" data-date="${dateStr}">
                 <span class="date-number">${day}</span>
                 <span class="festival-count">${count > 0 ? count + 'ê°œ ì¶•ì œ' : ''}</span>
             </div>
         `);
         
         // ì…€ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
         cell.on('click', function() {
             clickDate(dateStr);
         });

         calendarEl.append(cell);
     }
     
     // 4-5. ë‹¬ë ¥ ë¡œë”© í›„, ê¸°ë³¸ìœ¼ë¡œ ì„ íƒí•  ë‚ ì§œ ê²°ì •
     const today = new Date();
     const currentMonthYearMatch = (today.getFullYear() === year && today.getMonth() + 1 === month);

     if (currentMonthYearMatch) {
         const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
         clickDate(todayStr); // í˜„ì¬ ì›”ì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ
     } else {
         // ë‹¤ë¥¸ ì›”ì´ë©´ ì›”ì˜ ì²« ë‚  ì„ íƒ
         clickDate(`${year}-${String(month).padStart(2, '0')}-01`);
     }

 };

  
  // ğŸ“Œ 5. jQuery document.ready ì´ë²¤íŠ¸ (ìµœìƒìœ„ ì‹¤í–‰ ë¶€ë¶„)
  $(document).ready(function() {

     // í˜„ì¬ ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
     $('.current-month').text(`${currentYear}.${String(currentMonth).padStart(2,'0')}`);

     // ì›” ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ë³€ê²½ìœ¼ë¡œ í˜ì´ì§€ ì´ë™)
     $('#prevMonthBtn').on('click', () => {
         let m = currentMonth - 1;
         let y = currentYear;
         if (m < 1) { m = 12; y--; }
         window.location.href = `/calendar?year=${y}&month=${m}`;
     });

     $('#nextMonthBtn').on('click', () => {
         let m = currentMonth + 1;
         let y = currentYear;
         if (m > 12) { m = 1; y++; }
         window.location.href = `/calendar?year=${y}&month=${m}`;
     });

     // ìµœì¢…: ë‹¬ë ¥ ë Œë”ë§ ì‹œì‘
     renderCalendar(currentYear, currentMonth);
     

     

 });
</script>

    </div>
</body>
</html>