<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>축제 달력</title>
</head>

<body>
    <div layout:fragment="content" class="container my-3">

        <style>
            body {
                font-family: 'Noto Sans KR', sans-serif;
            }

            .calendar-container {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
                position: relative;
            }

            .calendar-container h2 {
                text-align: left !important;
                font-size: 1.2rem;
                font-weight: 700;
                margin-bottom: 5px !important;
                color: #495057;
            }

            .calendar-container .current-month {
                font-size: 2.5rem;
                font-weight: 800;
                color: #FF7732;  /* 주황색으로 변경 */
                display: block;
                margin-bottom: 20px;
            }

            /* 이전/다음 화살표 위치 & 스타일 */
            .calendar-container {
                position: relative;
            }
            .calendar-nav {
                position: absolute;
                top: 50px;     /* 월 텍스트 위쪽 */
                right: 30px;
                z-index: 15;
                display: flex;
                align-items: center;
            }
            .calendar-nav button {
                background: none;
                border: 1px solid #ccc;
                border-radius: 50%;
                width: 38px;
                height: 38px;
                color: #FF7732; /* 주황색으로 변경 */
                font-weight: bold;
                font-size: 1.2rem;
                margin-left: 5px;
                cursor: pointer;
                transition: background-color 0.2s;
                position: relative;
                z-index: 20;
            }
            .calendar-nav button:hover {
                background-color: #f0f0f0;
            }

            .calendar-header,
            .calendar-body {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
            }

            .day-of-week {
                padding: 15px 10px;
                text-align: center;
                font-size: 1.1rem;
                font-weight: 700;
                border: none;
                border-bottom: 2px solid #FF7732; /* 주황색으로 변경 */
                background-color: white;
                color: #495057;
            }

            .calendar-header .day-of-week:nth-child(1) { color: #dc3545; }
            .calendar-header .day-of-week:nth-child(7) { color: #0d6efd; }

            .calendar-cell {
                min-height: 100px;
                padding: 10px;
                text-align: center;
                border: none;
                border-right: 1px solid #f0f0f0;
                border-bottom: 1px solid #f0f0f0;
                cursor: pointer;
                transition: background-color 0.2s, box-shadow 0.2s, border 0.2s;
                user-select: none;
                position: relative;
                box-sizing: border-box;
            }
            .calendar-cell:nth-child(7n) {
                border-right: none;
            }

            .calendar-cell .date-number {
                font-size: 1.5rem;
                font-weight: 500;
                color: #495057;
                margin-bottom: 5px;
            }
            .calendar-cell:nth-child(7n+1) .date-number { color: #dc3545; }
            .calendar-cell:nth-child(7n) .date-number { color: #0d6efd; }

            .festival-count {
                font-size: 0.8rem;
                color: #FF7732; /* 주황색으로 변경 */
                display: block;
                margin-top: 5px;
                font-weight: 500;
            }

            .calendar-cell:hover:not(.empty-cell):not(.selected) {
                background-color: rgba(255,119,50,0.10); /* 연한 주황 */
                border: 3px solid #FF7732; /* 주황 테두리 */
                border-radius: 8px;
                margin: -2px;
                z-index: 5;
            }

            .calendar-cell.selected {
                background-color: #FF7732 !important; /* 주황으로 강조 */
                color: white !important;
                border: none !important;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                z-index: 10;
                margin: 0;
            }
            .calendar-cell.selected .date-number,
            .calendar-cell.selected .festival-count {
                color: white !important;
            }

            .festival-arrow {
                display: none;
                font-size: 1.5rem;
                line-height: 0.5;
                position: absolute;
                bottom: 15px;  /* 위로 올림 */
                left: 50%;
                transform: translateX(-50%);
            }
            .calendar-cell.selected .festival-arrow {
                display: block;
                color: white;
            }

            .calendar-cell.border-day {
                border: none;
                margin: 0;
            }
        </style>

        <div class="calendar-container">
            <div class="calendar-nav">
                <button id="prevMonthBtn">&larr;</button>
                <button id="nextMonthBtn">&rarr;</button>
            </div>

            <h2>월별 축제 달력</h2>
            <span class="current-month"></span>

            <div class="calendar-header">
                <div class="day-of-week">일</div>
                <div class="day-of-week">월</div>
                <div class="day-of-week">화</div>
                <div class="day-of-week">수</div>
                <div class="day-of-week">목</div>
                <div class="day-of-week">금</div>
                <div class="day-of-week">토</div>
            </div>

            <div class="calendar-body" id="festivalCalendar">
            </div>
        </div>

        <hr class="my-5">

        <h3>축제 리스트</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="festivalList">
        </div>

        <script>
            const festivalData = [
                { name: "메리마마 크리스마스", date_start: "2025-11-01", date_end: "2025-11-23", location: "천안", image: "/image/christmas.png" },
                { name: "별빛 축제", date_start: "2025-11-18", date_end: "2025-12-25", location: "구미", image: "/image/starlight.png" },
                { name: "힐링 콘서트", date_start: "2025-11-21", date_end: "2025-11-21", location: "서울", image: "/image/concert.png" },
                { name: "전국 음식 박람회", date_start: "2025-11-21", date_end: "2025-11-22", location: "부산", image: "/image/food.png" },
                { name: "코딩 축제", date_start: "2025-11-21", date_end: "2025-11-21", location: "대전", image: "/image/code.png" },
                { name: "가을 단풍 축제", date_start: "2025-11-21", date_end: "2025-11-25", location: "단양", image: "/image/maple.png" },
                { name: "낭만 빛 거리", date_start: "2024-10-22", date_end: "2025-12-31", location: "전국", image: "/image/light.png" }
            ];

            $(document).ready(function() {
                const today = new Date();
                let currentYear = today.getFullYear();
                let currentMonth = today.getMonth() + 1;
                let todayDay = today.getDate();
                const todayDateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(todayDay).padStart(2,'0')}`;

                const getFestivalCounts = (year, month) => {
                    const counts = {};
                    const daysInMonth = new Date(year, month, 0).getDate();
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                        const activeFestivals = festivalData.filter(f =>
                            new Date(f.date_start) <= new Date(dateStr)
                            && new Date(f.date_end) >= new Date(dateStr));
                        if (activeFestivals.length > 0) counts[dateStr] = activeFestivals.length;
                    }
                    return counts;
                };

                const renderCalendar = (year, month) => {
                    const calendarEl = $('#festivalCalendar');
                    calendarEl.empty();
                    $('.current-month').text(`${year}.${String(month).padStart(2,'0')}`);
                    const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const festivalCounts = getFestivalCounts(year, month);

                    for (let i = 0; i < firstDayOfMonth; i++) {
                        calendarEl.append('<div class="calendar-cell empty-cell"></div>');
                    }
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                        const count = festivalCounts[dateStr] || 0;
                        let cellHtml = `<div class="date-number">${day}</div>`;
                        if (count > 0) {
                            cellHtml += `<span class="festival-count">${count}개</span>`;
                            cellHtml += `<span class="festival-arrow">⌄</span>`;
                        }
                        calendarEl.append(`<div class="calendar-cell ${count>0 ? 'has-festivals' : ''}" data-date="${dateStr}" data-count="${count}">${cellHtml}</div>`);
                    }
                    $('.calendar-cell.has-festivals').on('click', handleDateClick);
                    if (year === today.getFullYear() && month === today.getMonth()+1) {
                        selectDate(todayDateStr);
                    }
                };

                function moveMonth(delta) {
                    let newMonth = currentMonth + delta;
                    let newYear = currentYear;
                    if (newMonth > 12) { newMonth = 1; newYear++; }
                    else if (newMonth < 1) { newMonth = 12; newYear--; }
                    currentYear = newYear;
                    currentMonth = newMonth;
                    renderCalendar(currentYear, currentMonth);
                }

                $('#prevMonthBtn').on('click', () => moveMonth(-1));
                $('#nextMonthBtn').on('click', () => moveMonth(1));

                let selectedDate = null;
                const selectDate = (dateStr) => {
                    $('.calendar-cell').removeClass('selected');
                    const newCell = $(`.calendar-cell[data-date="${dateStr}"]`);
                    if (newCell.length) {
                        newCell.addClass('selected');
                        selectedDate = dateStr;
                        renderFestivalList(selectedDate);
                    }
                };

                function handleDateClick() {
                    const dateStr = $(this).data('date');
                    selectDate(dateStr);
                }

                const renderFestivalList = (dateStr) => {
                    const listEl = $('#festivalList');
                    listEl.empty();
                    const filtered = festivalData.filter(f =>
                        new Date(f.date_start) <= new Date(dateStr)
                        && new Date(f.date_end) >= new Date(dateStr));
                    if (filtered.length === 0) {
                        listEl.append('<div class="col"><p>선택하신 날짜에는 진행 중인 축제가 없습니다.</p></div>');
                    } else {
                        filtered.forEach(f => {
                            listEl.append(`
                                <div class="col">
                                    <div class="card h-100">
                                        <img src="${f.image}" class="card-img-top" alt="${f.name}" style="height:150px; object-fit:cover;">
                                        <div class="card-body">
                                            <h5 class="card-title">${f.name}</h5>
                                            <p class="card-text"><small class="text-muted">${f.date_start.slice(5).replace('-','.')}-${f.date_end.slice(5).replace('-','.')}</small><br>${f.location}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                        });
                    }
                };

                renderCalendar(currentYear, currentMonth);
            });
        </script>

    </div>
</body>
</html>
