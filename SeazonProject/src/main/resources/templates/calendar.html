<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout}">

<head>
    <title>ì¶•ì œ ë‹¬ë ¥</title>
</head>

<body>
    <div layout:fragment="content" class="container my-3">

        <style>
            /* í°íŠ¸: ì‹œìŠ¤í…œ í°íŠ¸ ì‚¬ìš© (Noto Sans KR ë“±ì´ ì ìš©ë˜ì—ˆë‹¤ê³  ê°€ì •) */
            body {
                font-family: 'Noto Sans KR', sans-serif;
            }
            /* ------------------- ë‹¬ë ¥ ì»¨í…Œì´ë„ˆ ë° ì œëª© ------------------- */
            .calendar-container {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
            }
            .calendar-container h2 {
                text-align: left !important;
                font-size: 1.2rem;
                font-weight: 700;
                margin-bottom: 5px !important;
                color: #495057;
            }
            .calendar-container .current-month {
                font-size: 2.5rem;
                font-weight: 800;
                color: #8a2be2;
                display: block;
                margin-bottom: 20px;
            }
            /* ------------------- ì´ì „/ë‹¤ìŒ ë‹¬ í™”ì‚´í‘œ ------------------- */
            .calendar-nav {
                text-align: right;
                margin-bottom: 10px;
            }
            .calendar-nav button {
                background: none;
                border: 1px solid #ccc;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                color: #8a2be2;
                font-weight: bold;
                margin-left: 5px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .calendar-nav button:hover {
                background-color: #f0f0f0;
            }
            /* ------------------- ë‹¬ë ¥ ë³¸ì²´ Grid ------------------- */
            .calendar-header, .calendar-body {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
            }
            .day-of-week {
                padding: 15px 10px;
                text-align: center;
                font-size: 1.1rem;
                font-weight: 700;
                border: none;
                border-bottom: 2px solid #8a2be2;
                background-color: white;
                color: #495057;
            }
            /* ì¼ìš”ì¼ê³¼ í† ìš”ì¼ ìƒ‰ìƒ ë³€ê²½ */
            .calendar-header .day-of-week:nth-child(1) { color: #dc3545; }
            .calendar-header .day-of-week:nth-child(7) { color: #0d6efd; }
            /* ------------------- ë‚ ì§œ ì…€ ìŠ¤íƒ€ì¼ ------------------- */
            .calendar-cell {
                min-height: 100px;
                padding: 10px;
                text-align: center;
                border: none;
                border-right: 1px solid #f0f0f0;
                border-bottom: 1px solid #f0f0f0;
                cursor: pointer;
                transition: background-color 0.2s, box-shadow 0.2s, border 0.2s;
                user-select: none;
                position: relative;
                box-sizing: border-box; 
            }
            .calendar-cell:nth-child(7n) {
                border-right: none;
            }

            /* ì¼ë°˜ ë‚ ì§œ ë²ˆí˜¸ ìŠ¤íƒ€ì¼ */
            .calendar-cell .date-number {
                font-size: 1.5rem;
                font-weight: 500;
                color: #495057;
                margin-bottom: 5px;
            }
            /* ì¼ìš”ì¼ ìƒ‰ìƒ */
            .calendar-cell:nth-child(7n+1) .date-number { color: #dc3545; } 
            /* í† ìš”ì¼ ìƒ‰ìƒ */
            .calendar-cell:nth-child(7n) .date-number { color: #0d6efd; } 

            /* ì¶•ì œ ê°œìˆ˜ ìŠ¤íƒ€ì¼ */
            .festival-count {
                font-size: 0.8rem;
                color: #8a2be2;
                display: block;
                margin-top: 5px;
                font-weight: 500;
            }

            /* ------------------- í˜¸ë²„ (ëŒì•„ë‹¤ë‹ˆë©´ì„œ ì„ íƒ) ìŠ¤íƒ€ì¼: ì—°í•œ ë°°ê²½ + ì§„í•œ í…Œë‘ë¦¬ ------------------- */
            .calendar-cell:hover:not(.empty-cell):not(.selected) {
                background-color: #f7f0ff; /* ì—°í•œ ë³´ë¼ìƒ‰ ë°°ê²½ */
                border: 3px solid #8a2be2; /* ì§„í•œ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ */
                border-radius: 8px; 
                margin: -2px; /* í…Œë‘ë¦¬ë¡œ ì¸í•´ ì…€ í¬ê¸°ê°€ ì»¤ì§€ëŠ” ê²ƒì„ ë°©ì§€ */
                z-index: 5;
            }

            /* ------------------- ì„ íƒëœ ë‚ ì§œ (Selected) ìŠ¤íƒ€ì¼: ì§„í•œ ë³´ë¼ìƒ‰ ë°°ê²½ ------------------- */
            .calendar-cell.selected {
                background-color: #8a2be2 !important; /* ì§„í•œ ë³´ë¼ìƒ‰ ë°°ê²½ìœ¼ë¡œ ê½‰ ì±„ì›€ */
                color: white !important;
                border: none !important; /* í…Œë‘ë¦¬ ì œê±° */
                border-radius: 8px; 
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                z-index: 10;
                margin: 0; /* ë§ˆì§„ ì´ˆê¸°í™” */
            }

            /* ì„ íƒëœ ì…€ ë‚´ë¶€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            .calendar-cell.selected .date-number,
            .calendar-cell.selected .festival-count {
                color: white !important;
            }

            /* ì¶•ì œ ê°œìˆ˜ ì•„ë˜ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ ì¶”ê°€ (ì„ íƒëœ ë‚ ì§œì—ë§Œ ë‚˜íƒ€ë‚¨) */
            .festival-arrow {
                display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
                font-size: 1.5rem;
                line-height: 0.5;
                position: absolute;
                bottom: 5px;
                left: 50%;
                transform: translateX(-50%);
            }
            .calendar-cell.selected .festival-arrow {
                display: block;
                color: white; /* í°ìƒ‰ í™”ì‚´í‘œ */
            }

            /* í•˜ë“œì½”ë”©ëœ ìŠ¤íƒ€ì¼ ì œê±° */
            .calendar-cell.border-day {
                border: none;
                margin: 0;
            }
        </style>


        <div class="calendar-nav">
            <button id="prevMonthBtn">&larr;</button>
            <button id="nextMonthBtn">&rarr;</button>
        </div>

        <div class="calendar-container">
            <h2>ì›”ë³„ ì¶•ì œ ë‹¬ë ¥</h2>
            <span class="current-month"></span>

            <div class="calendar-header">
                <div class="day-of-week">ì¼</div>
                <div class="day-of-week">ì›”</div>
                <div class="day-of-week">í™”</div>
                <div class="day-of-week">ìˆ˜</div>
                <div class="day-of-week">ëª©</div>
                <div class="day-of-week">ê¸ˆ</div>
                <div class="day-of-week">í† </div>
            </div>

            <div class="calendar-body" id="festivalCalendar">
            </div>
        </div>

        <hr class="my-5">

        <h3>ì¶•ì œ ë¦¬ìŠ¤íŠ¸</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="festivalList">
        </div>


        <script>
            // ğŸ‘‡ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì˜¬ ì˜ˆì •ì´ë¯€ë¡œ, í˜„ì¬ëŠ” ì„ì‹œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ğŸ‘‡
            const festivalData = [
                { name: "ë©”ë¦¬ë§ˆë§ˆ í¬ë¦¬ìŠ¤ë§ˆìŠ¤", date_start: "2025-11-01", date_end: "2025-11-23", location: "ì²œì•ˆ", image: "/image/christmas.png" },
                { name: "ë³„ë¹› ì¶•ì œ", date_start: "2025-11-18", date_end: "2025-12-25", location: "êµ¬ë¯¸", image: "/image/starlight.png" },
                { name: "íë§ ì½˜ì„œíŠ¸", date_start: "2025-11-21", date_end: "2025-11-21", location: "ì„œìš¸", image: "/image/concert.png" },
                { name: "ì „êµ­ ìŒì‹ ë°•ëŒíšŒ", date_start: "2025-11-21", date_end: "2025-11-22", location: "ë¶€ì‚°", image: "/image/food.png" },
                { name: "ì½”ë”© ì¶•ì œ", date_start: "2025-11-21", date_end: "2025-11-21", location: "ëŒ€ì „", image: "/image/code.png" },
                { name: "ê°€ì„ ë‹¨í’ ì¶•ì œ", date_start: "2025-11-21", date_end: "2025-11-25", location: "ë‹¨ì–‘", image: "/image/maple.png" },
                { name: "ë‚­ë§Œ ë¹› ê±°ë¦¬", date_start: "2024-10-22", date_end: "2025-12-31", location: "ì „êµ­", image: "/image/light.png" },
            ];

            $(document).ready(function() {
                const today = new Date();
                
                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ í˜„ì¬ ì—°ë„ì™€ ì›” ì„¤ì •
                let currentYear = today.getFullYear(); 
                let currentMonth = today.getMonth() + 1; // getMonth()ëŠ” 0ë¶€í„° ì‹œì‘
                let todayDay = today.getDate();

                // YYYY-MM-DD í˜•ì‹ì˜ ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´
                const todayDateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(todayDay).padStart(2, '0')}`;


                // 1. í˜„ì¬ ì¶•ì œ ë°ì´í„° ê´€ë¦¬
                const getFestivalCounts = (year, month) => {
                    const counts = {}; 
                    const daysInMonth = new Date(year, month, 0).getDate();
                    
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        
                        const activeFestivals = festivalData.filter(f => 
                            new Date(f.date_start) <= new Date(dateStr) && new Date(f.date_end) >= new Date(dateStr)
                        );
                        if (activeFestivals.length > 0) {
                            counts[dateStr] = activeFestivals.length;
                        }
                    }
                    return counts;
                };

                // 2. ë‹¬ë ¥ ìƒì„± í•¨ìˆ˜
                const renderCalendar = (year, month) => {
                    const calendarEl = $('#festivalCalendar');
                    calendarEl.empty();
                    
                    $('.current-month').text(`${year}.${String(month).padStart(2, '0')}`);
                    
                    const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const festivalCounts = getFestivalCounts(year, month);
                    
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        calendarEl.append('<div class="calendar-cell empty-cell"></div>');
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const count = festivalCounts[dateStr] || 0;
                        
                        let cellHtml = `<div class="date-number">${day}</div>`;
                        if (count > 0) {
                            cellHtml += `<span class="festival-count">${count}ê°œ</span>`;
                            cellHtml += `<span class="festival-arrow">âŒ„</span>`; // í™”ì‚´í‘œ ì¶”ê°€
                        }
                        
                        calendarEl.append(
                            `<div class="calendar-cell ${count > 0 ? 'has-festivals' : ''}" 
                                  data-date="${dateStr}" 
                                  data-count="${count}">
                                ${cellHtml}
                            </div>`
                        );
                    }
                    
                    // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
                    $('.calendar-cell.has-festivals').on('click', handleDateClick);
                    
                    // ë Œë”ë§ í›„ ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ (í˜„ì¬ ë‹¬ì— ìˆì„ ê²½ìš°)
                    if (year === today.getFullYear() && month === today.getMonth() + 1) {
                         selectDate(todayDateStr);
                    }
                };
                
                // ì´ì „/ë‹¤ìŒ ë‹¬ ì´ë™ í•¨ìˆ˜
                function moveMonth(delta) {
                    let newMonth = currentMonth + delta;
                    let newYear = currentYear;

                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    currentYear = newYear;
                    currentMonth = newMonth;
                    renderCalendar(currentYear, currentMonth);
                }

                // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
                $('#prevMonthBtn').on('click', () => moveMonth(-1));
                $('#nextMonthBtn').on('click', () => moveMonth(1));


                // 3. ë‚ ì§œ ì„ íƒ ë¡œì§ (í´ë¦­ ì´ë²¤íŠ¸ì™€ ì´ˆê¸° ë¡œë“œì—ì„œ ì¬ì‚¬ìš©)
                let selectedDate = null;
                const selectDate = (dateStr) => {
                    // ê¸°ì¡´ ì„ íƒ í•´ì œ
                    $('.calendar-cell').removeClass('selected');
                    
                    // ìƒˆ ë‚ ì§œ ì„ íƒ ë° ìŠ¤íƒ€ì¼ ì ìš©
                    const newSelectedCell = $(`.calendar-cell[data-date="${dateStr}"]`);
                    if (newSelectedCell.length) {
                        newSelectedCell.addClass('selected');
                        selectedDate = dateStr;
                        renderFestivalList(selectedDate);
                    }
                }
                
                // 3. ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                function handleDateClick() {
                    const dateStr = $(this).data('date');
                    selectDate(dateStr);
                }
                
                // 4. ì¶•ì œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
                const renderFestivalList = (dateStr) => {
                    const listEl = $('#festivalList');
                    listEl.empty();
                    
                    const filteredFestivals = festivalData.filter(f => 
                        new Date(f.date_start) <= new Date(dateStr) && new Date(f.date_end) >= new Date(dateStr)
                    );
                    
                    if (filteredFestivals.length === 0) {
                        listEl.append('<div class="col"><p>ì„ íƒí•˜ì‹  ë‚ ì§œì—ëŠ” ì§„í–‰ ì¤‘ì¸ ì¶•ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>');
                        return;
                    }

                    filteredFestivals.forEach(festival => {
                        const cardHtml = `
                            <div class="col">
                                <div class="card h-100">
                                    <img src="${festival.image}" class="card-img-top" alt="${festival.name}" style="height: 150px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">${festival.name}</h5>
                                        <p class="card-text">
                                            <small class="text-muted">${festival.date_start.slice(5).replace('-', '.')}-${festival.date_end.slice(5).replace('-', '.')}</small>
                                            <br>
                                            <span>${festival.location}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                        listEl.append(cardHtml);
                    });
                };

                // 5. ì´ˆê¸° ë‹¬ë ¥ ë Œë”ë§ (ì˜¤ëŠ˜ ë‚ ì§œê°€ í¬í•¨ëœ ë‹¬)
                renderCalendar(currentYear, currentMonth);
            });
        </script>

    </div>
</body>
</html>