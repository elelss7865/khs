<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container">

   <!-- 여행지 등록 -->
   <h5 class="my-5 border-bottom pb-2">여행지 등록</h5>
   
   <form th:object="${travelForm}" method="post"
      enctype="multipart/form-data">
      <input type="hidden" th:name="${_csrf.parameterName}"
         th:value="${_csrf.token}" />
      <div th:replace="form_errors :: formErrorsFragment"></div>

      <!-- 여행지 등록 -->
      <table class="table table-borderless" style="margin: 20px 0px 0px 0px;">

         <tbody>

            <!-- 여행지 이름(subject) -->
            <tr>
               <td></td>
               <td><label for="subject" class="form-label">여행지 이름</label></td>
               <td><input type="text" th:field="*{subject}" class="form-control"></td>
                  
            <!-- 사진 첨부 -->      
               <td rowspan='3'><label for="file" class="for-label">사진</label>
                  <input type="file" name="file" th:field="*{file}"onchange="setThumbnail(event);"/>
                       <div id="image_container"></div>
                    </td>
            </tr>

            <!-- 여행지 설명(travelIntro) -->
            <tr>
               <td></td>
               <td><label for="travelIntro" class="form-label">여행지 설명</label></td>
               <td><textarea type="text" th:field="*{travelIntro}"
                     class="form-control"></textarea></td>
            </tr>

            <!-- 카테고리(category) -->
            <tr>
                <td></td>
               <td><label for="category" class="form-label">카테고리</label></td>
               <td><div style="display: inline-block;">
                     <select class="form-select" aria-label="Default select example" th:field="*{category}">
                        <option value="">지역별</option>
                        <option value="밥요리">밥요리</option>
                        <option value="국/탕">국/탕</option>
                        <option value="찌개/전골">찌개/전골</option>
                        <option value="밑반찬">밑반찬</option>
                        <option value="김치장아찌">김치장아찌</option>
                        <option value="면요리">면요리</option>
                        <option value="샐러드">샐러드</option>
                        <option value="간식/분식">간식/분식</option>
                        <option value="베이킹">베이킹</option>
                        <option value="디저트">디저트</option>
                        <option value="기타">기타</option>
                     </select>
                  </div>

                  <div style="display: inline-block;">
                     <select class="form-select" aria-label="Default select example" th:field="*{category}">
                        <option value="">상황별</option>
                        <option value="손님상">손님상</option>
                        <option value="아이반찬">아이반찬</option>
                        <option value="도시락">도시락</option>
                        <option value="야식/술안주">야식/술안주</option>
                        <option value="명절요리">명절요리</option>
                        <option value="기타">기타</option>
                     </select>
                  </div>

                  <div style="display: inline-block;">
                     <select class="form-select" aria-label="Default select example" th:field="*{category}">
                        <option value="">방법별</option>
                        <option value="볶음요리">볶음요리</option>
                        <option value="구이(고기/생선)">구이(고기/생선)</option>
                        <option value="찜/조림">찜/조림</option>
                        <option value="튀김">튀김</option>
                        <option value="기타">기타</option>
                     </select>
                  </div></td>
            </tr>
      
      <hr style="border:solid 5px gray;">
      
       <!-- 여행지 정보 -->
       <table style="margin-left:150px">
          <tbody id="content">
              <tr class="form-label">
                  <td><label for="step" class="form-label" style="margin-right:10px"></label></td>
                  <td><input type="text" name="content" th:field="*{content}" style="width:350px; height:200px; margin-bottom:40px"></td>
                  <td class="image-container">
                      <img style="width:200px;" id="preview-image" src="https://dummyimage.com/200X200/ffffff/000000.gif&text=preview-image">
                      <input style="display: block;" type="file" th:field="*{contentFile}" id="input-image" onchange="readImage(this)">
                  </td>
                  <td><input type="button" value="추가" class="btn btn-outline-warning btn-sm" onclick="add_contentbox()"></td>
              </tr>
          </tbody>
      </table>
        
        <hr style="border:solid 5px gray;"> 
        
        <!-- 버튼 -->
        <div class="d-flex justify-content-center">
           <input type="submit" value="저장하기" class="btn btn-warning my-2 btn-lg">
      </div>
      
   </form>

   <script>
       // 썸네일 미리보기
      function setThumbnail(event) {
         var reader = new FileReader();

         reader.onload = function(event) {
            var img = document.createElement("img");
            img.setAttribute("src", event.target.result);
            img.style.width = "300px"; // 이미지 너비를 300px로 조정
            img.style.height = "200px"; // 이미지 높이를 200px로 조정
            document.querySelector("div#image_container").appendChild(img);
         };

         reader.readAsDataURL(event.target.files[0]);
      }
      
      // input box(ingredient)
      const add_ingredientbox = () => {
        const box = document.getElementById("ingredient");
        const newP = document.createElement('p');
        newP.innerHTML = `<input type='text' name='ingredient' style='width: 400px'> 
                          <input type='text' name='capacity' style='width: 400px'> 
                          <input type='button' value='삭제' class='btn btn-outline-warning btn-sm' onclick='removeIngredient(this)'>`;
        box.appendChild(newP);
       }
       
       const removeIngredient = (obj) => {
           document.getElementById('ingredient').removeChild(obj.parentNode);
       }   
           
        // input box(content)
      let rowCount = 1;
      
        // 추가
      const add_contentbox = () => {
          const table = document.getElementById("content");
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
              <td><label for="step${rowCount}" class="form-label" style="margin-right:10px">STEP${rowCount}</label></td>
              <td><input type="text" name="content" th:field="*{content}" style="width:350px; height:200px; margin-bottom:40px"></td>
              <td class="image-container">
                  <img style="width:200px;" id="preview-image-${rowCount}" src="https://dummyimage.com/200X200/ffffff/000000.gif&text=preview-image">
                  <input style="display: block;" type="file" id="input-image-${rowCount}" onchange="readImage(this)">
              </td>
              <td><input type="button" value="삭제" class="btn btn-outline-warning btn-sm" onclick="removeContent(this)"></td>
          `;
          table.appendChild(newRow);
          updateStepNumbers();
          rowCount++;
      }
      
      // 삭제
      const removeContent = (obj) => {
          const row = obj.parentNode.parentNode;
          row.parentNode.removeChild(row);
          updateStepNumbers();
      }
      
      // label count
      const updateStepNumbers = () => {
          const rows = document.getElementById('content').getElementsByTagName('tr');
          for (let i = 0; i < rows.length; i++) {
              const label = rows[i].querySelector('label');
              label.innerText = `STEP${i + 1}`;
          }
      }
      
      // 미리보기 이미지
      function readImage(input) {
          const previewImage = input.parentNode.querySelector('img');
          if (input.files && input.files[0]) {
              const reader = new FileReader();
              reader.onload = e => {
                  previewImage.src = e.target.result;
              };
              reader.readAsDataURL(input.files[0]);
          } else {
              previewImage.src = "https://dummyimage.com/200X200/ffffff/000000.gif&text=preview-image";
          }
      }
        
   </script>
</div>
</html>